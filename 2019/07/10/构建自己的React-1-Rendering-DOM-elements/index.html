<!DOCTYPE html><html lang="中文"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 构建自己的React(1):Rendering DOM elements · Neo</title><meta name="description" content="手写自己的react react"><meta name="viewport" content="width=device-width, initial-scale=1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui"><meta name="keywords" content="手写react 虚拟DOM"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="apple-touch-icon" href="2048/meta/apple-touch-icon.png"><link rel="apple-touch-startup-image" href="2048/meta/apple-touch-startup-image-640x1096.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"><link rel="apple-touch-startup-image" href="2048/meta/apple-touch-startup-image-640x920.png" media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146300475-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date())

gtag('config', 'UA-146300475-1')
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cfd774e7572f024fbb235d52afbd4103";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="search" type="application/opensearchdescription+xml" href="http://mengfansheng.com/atom.xml" title="Neo"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Neo" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://segmentfault.com/a/1190000017234428" target="_blank" class="nav-list-link">SEGMENGFAULT</a></li><li class="nav-list-item"><a href="https://github.com/xusanduo08" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/2048/" target="_self" class="nav-list-link">GAMES</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">构建自己的React(1):Rendering DOM elements</h1><div class="post-info">Jul 10, 2019</div><div class="post-content"><p>翻译自这里：<a target="_blank" rel="noopener" href="https://engineering.hexacta.com/didact-rendering-dom-elements-91c9aa08323b">https://engineering.hexacta.com/didact-rendering-dom-elements-91c9aa08323b</a><br>本系列的目的是创建类似于React的一个简易的工具库。</p>
<h4 id="DOM-review"><a href="#DOM-review" class="headerlink" title="DOM review"></a>DOM review</h4><p>开始之前，我们先看下我们要用到的DOM API：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过id查找元素</span></span><br><span class="line"><span class="keyword">const</span> domRoot = <span class="built_in">document</span>.getElementById(<span class="string">&quot;root&quot;</span>);</span><br><span class="line"><span class="comment">// 根据执行标签名创建元素</span></span><br><span class="line"><span class="keyword">const</span> domInput = <span class="built_in">document</span>.createElement(<span class="string">&quot;input&quot;</span>);</span><br><span class="line"><span class="comment">// 设置元素属性</span></span><br><span class="line">domInput[<span class="string">&quot;type&quot;</span>] = <span class="string">&quot;text&quot;</span>;</span><br><span class="line">domInput[<span class="string">&quot;value&quot;</span>] = <span class="string">&quot;Hi world&quot;</span>;</span><br><span class="line">domInput[<span class="string">&quot;className&quot;</span>] = <span class="string">&quot;my-class&quot;</span>;</span><br><span class="line"><span class="comment">// 添加事件监听</span></span><br><span class="line">domInput.addEventListener(<span class="string">&quot;change&quot;</span>, <span class="function"><span class="params">e</span> =&gt;</span> alert(e.target.value));</span><br><span class="line"><span class="comment">// 创建文本节点</span></span><br><span class="line"><span class="keyword">const</span> domText = <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">// 设置节点内容</span></span><br><span class="line">domText[<span class="string">&quot;nodeValue&quot;</span>] = <span class="string">&quot;Foo&quot;</span>;</span><br><span class="line"><span class="comment">// 往页面上添加元素</span></span><br><span class="line">domRoot.appendChild(domInput);</span><br><span class="line"><span class="comment">// 往页面上添加文本节点</span></span><br><span class="line">domRoot.appendChild(domText);</span><br></pre></td></tr></table></figure>

<p>注意到这里我们给元素设置了properties而不是attributes，而且只有有效的properties才能被设置。</p>
<h4 id="Didact-Elements"><a href="#Didact-Elements" class="headerlink" title="Didact Elements"></a>Didact Elements</h4><p>我们用原生的JS对象来描述我们要渲染的东西，并称这类对象为Didact Elements。这些元素对应的JS对象都有两个必要的属性：<code>type</code>和<code>props</code>。<code>type</code>可以是个字符串也可以是一个函数，但在我们介绍组件之前我们先只使用字符串。<code>props</code>是一个可以为空（<code>null</code>）的对象。<code>props</code>下还可以含有<code>children</code>属性，<code>children</code>属性值为一个装有Didact Elements的数组。</p>
<blockquote>
<p>我们后面将会频繁的使用Didact Elements，所以我们会用元素称呼Didact Elements。不要和HTML的元素搞混了，HTML元素会被称作DOM元素或者使用命名变量时干脆就叫<code>dom</code>。</p>
</blockquote>
<p>举个例子，我们会用下面这个对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&quot;container&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>, <span class="attr">props</span>: &#123; <span class="attr">value</span>: <span class="string">&quot;foo&quot;</span>, <span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&quot;a&quot;</span>, <span class="attr">props</span>: &#123; <span class="attr">href</span>: <span class="string">&quot;/bar&quot;</span> &#125; &#125;,</span><br><span class="line">      &#123; <span class="attr">type</span>: <span class="string">&quot;span&quot;</span>, <span class="attr">props</span>: &#123;&#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>来描述下面这个dom：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;container&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;foo&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/bar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Didact Elements和React Elements很像。但通常情况下你不会使用JS手动去创建一个React Elements，更多的是使用JSX或者是<code>createElement</code>方法来创建。在Didact中我们也会使用相同的方法创建元素，但会将这部分内容放在下一节。</p>
<h4 id="Render-DOM-Elements"><a href="#Render-DOM-Elements" class="headerlink" title="Render DOM Elements"></a>Render DOM Elements</h4><p>下一步是将元素及其子元素渲染成dom。我们使用<code>render</code>（类似于<code>ReactDOM.render</code>）方法来接收一个元素和一个dom容器。这个方法会将这个元素描述的dom结构创建出来，并添加到容器内。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, parentDom</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, props &#125; = element;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">    <span class="keyword">const</span> childElements = props.children || [];</span><br><span class="line">    childElements.forEach(<span class="function"><span class="params">childElement</span> =&gt;</span> render(childElement, dom));</span><br><span class="line">    parentDom.appendChild(dom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在仍没有处理属性和事件。我们先用<code>Object.keys</code>来获取<code>props</code>中的属性名字，然后循环将它们设定到元素上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, parentDom</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, props &#125; = element;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> isListener = <span class="function"><span class="params">name</span> =&gt;</span> name.startsWith(<span class="string">&quot;on&quot;</span>);</span><br><span class="line">    <span class="built_in">Object</span>.keys(props).filter(isListener).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> eventType = name.toLowerCase().substring(<span class="number">2</span>);</span><br><span class="line">        dom.addEventListener(eventType, props[name]);</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> isAttribute = <span class="function"><span class="params">name</span> =&gt;</span> !isListener(name) &amp;&amp; name != <span class="string">&quot;children&quot;</span>;</span><br><span class="line">    <span class="built_in">Object</span>.keys(props).filter(isAttribute).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">        dom[name] = props[name];</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> childElements = props.children || [];</span><br><span class="line">    childElements.forEach(<span class="function"><span class="params">childElement</span> =&gt;</span> render(childElement, dom));</span><br><span class="line">    parentDom.appendChild(dom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Render-DOM-Text-Nodes"><a href="#Render-DOM-Text-Nodes" class="headerlink" title="Render DOM Text Nodes"></a>Render DOM Text Nodes</h4><p>目前<code>render</code>还不支持文本节点。首先我们要定义文本节点是什么样的。在react中，一个<code>&lt;span&gt;Foo&lt;/span&gt;</code>这样的元素需要这样描述：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reactElement = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;span&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">children</span>: [<span class="string">&quot;Foo&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到这里的子元素已经不是对象，而只是一个字符串。这和我们对Didact Elements的定义有不一样：<code>children</code>应该是装有Didact Elements的数组，并且所有元素都有<code>type</code>和<code>props</code>属性。如果我们继续遵守这个规则接下来我们将较少使用<code>if</code>的次数。所以，Didact Elements将会使用<code>type=&quot;TEXT_ELEMENT&quot;</code>来表示文本节点，并使用<code>nodeValue</code>来装文本值。例如下面这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> textElement = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;span&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;TEXT_ELEMENT&quot;</span>,</span><br><span class="line">        <span class="attr">props</span>: &#123; <span class="attr">nodeValue</span>: <span class="string">&quot;Foo&quot;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在我们已经定义好了能够渲染的文本节点。和其他节点不同的是，文本节点需要使用<code>createTextNode</code>来创建而不是<code>createElement</code>，而<code>nodeValue</code>会通过相同方法来设置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, parentDom</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = element;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建DOM</span></span><br><span class="line">  <span class="keyword">const</span> isTextElement = type === <span class="string">&quot;TEXT_ELEMENT&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> dom = isTextElement</span><br><span class="line">    ? <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    : <span class="built_in">document</span>.createElement(type);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加事件监听</span></span><br><span class="line">  <span class="keyword">const</span> isListener = <span class="function"><span class="params">name</span> =&gt;</span> name.startsWith(<span class="string">&quot;on&quot;</span>);</span><br><span class="line">  <span class="built_in">Object</span>.keys(props).filter(isListener).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> eventType = name.toLowerCase().substring(<span class="number">2</span>);</span><br><span class="line">    dom.addEventListener(eventType, props[name]);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置属性</span></span><br><span class="line">  <span class="keyword">const</span> isAttribute = <span class="function"><span class="params">name</span> =&gt;</span> !isListener(name) &amp;&amp; name != <span class="string">&quot;children&quot;</span>;</span><br><span class="line">  <span class="built_in">Object</span>.keys(props).filter(isAttribute).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    dom[name] = props[name];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归渲染子元素</span></span><br><span class="line">  <span class="keyword">const</span> childElements = props.children || [];</span><br><span class="line">  childElements.forEach(<span class="function"><span class="params">childElement</span> =&gt;</span> render(childElement, dom));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将dom添加到父dom内</span></span><br><span class="line">  parentDom.appendChild(dom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>我们目前创建了一个可以渲染元素及其子元素为DOM的<code>render</code>方法。下一步我们需要一个快速简单的方法来创建元素。下一节我们将在Didact中使用JSX。</p>
<p>下一节：</p>
<p><a target="_blank" rel="noopener" href="https://engineering.hexacta.com/didact-element-creation-and-jsx-d05171c55c56">https://engineering.hexacta.com/didact-element-creation-and-jsx-d05171c55c56</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/07/25/%E5%86%99%E4%B8%80%E4%B8%AAredux-saga-1_saga%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/" class="prev">PREV</a><a href="/2019/06/25/%E6%9E%84%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84React-2-Element-creation-and-JSX-md/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2019/07/10/构建自己的React-1-Rendering-DOM-elements/';
var disqus_title = '构建自己的React(1):Rendering DOM elements';
var disqus_url = 'http://mengfansheng.com/2019/07/10/构建自己的React-1-Rendering-DOM-elements/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2021 <a href="http://mengfansheng.com">孟凡胜</a>, <a href="http://www.beian.miit.gov.cn" target="_blank">苏ICP备17022623号</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>